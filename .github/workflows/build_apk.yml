name: ğŸš€ Build & Release APK (Flutter) ğŸš€

on:
  push:
    branches:
      - main  # ğŸŒ³ Roda quando hÃ¡ push na branch 'main' (ou 'master', ajuste se necessÃ¡rio)
  pull_request:
    branches:
      - main  # ğŸ” Roda quando um Pull Request Ã© aberto/atualizado para 'main'
  workflow_dispatch: # âš™ï¸ Permite executar manualmente o workflow pela interface do GitHub

jobs:
  build_apk:
    name: ğŸ—ï¸ Build Android APK
    runs-on: ubuntu-latest # ğŸ§ Usa a versÃ£o mais recente do Ubuntu para o runner

    steps:
      - name: â¬‡ï¸ Checkout do RepositÃ³rio
        uses: actions/checkout@v4 # ğŸ“¦ Baixa o cÃ³digo do seu repositÃ³rio

      - name: ğŸ’™ Configurar Flutter SDK
        uses: subosito/flutter-action@v2 # ğŸš€ Configura o ambiente Flutter
        with:
          flutter-version: '3.x.x' # ğŸ¯ Especifica a versÃ£o do Flutter. Ex: '3.19.0' ou '3.x.x' para a mais recente 3.x.x
          cache: true # âš¡ Ativa o cache para downloads mais rÃ¡pidos de dependÃªncias

      - name: ğŸ§© Instalar DependÃªncias (flutter pub get)
        run: flutter pub get # âœ¨ Baixa todas as dependÃªncias do projeto

      - name: ğŸ§ª Executar Testes (Opcional, mas recomendado!)
        run: flutter test # âœ… Executa os testes unitÃ¡rios e de widget

      - name: âš™ï¸ Buildar o APK de Release
        run: flutter build apk --release # ğŸš€ Compila o APK otimizado para lanÃ§amento

      - name: ğŸ“¦ Renomear APK (Opcional)
        run: |
          BUILD_NUMBER=${{ github.run_number }}
          mv build/app/outputs/flutter-apk/app-release.apk build/app/outputs/flutter-apk/app-release-$BUILD_NUMBER.apk
        # ğŸ·ï¸ Renomeia o APK gerado para incluir o nÃºmero da build do GitHub Actions.
        # Isso ajuda a identificar qual versÃ£o do APK foi gerada por qual execuÃ§Ã£o do workflow.
        # Ex: app-release-123.apk

      - name: â¬†ï¸ Upload do APK como Artefato
        uses: actions/upload-artifact@v4 # ğŸ“¤ Envia o APK compilado como um artefato da build
        with:
          name: app-release-apk # ğŸ“ Nome do artefato
          path: build/app/outputs/flutter-apk/app-release-*.apk # ğŸ“ Caminho para o APK (usando curinga para pegar o renomeado)
          retention-days: 5 # ğŸ—“ï¸ MantÃ©m o artefato por 5 dias

      - name: ğŸ“ Criar Release no GitHub (Opcional, mas Ãºtil!)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' # Apenas em push para main
        uses: softprops/action-gh-release@v1 # ğŸ“ Cria um rascunho de Release no GitHub
        with:
          tag_name: v${{ github.run_number }} # ğŸ·ï¸ Tag da Release (ex: v1, v2)
          name: Release v${{ github.run_number }} # ğŸ“ Nome da Release
          body: |
            âœ¨ Nova versÃ£o do aplicativo gerada automaticamente pelo CI/CD.
            [Link para a build](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          draft: true # ğŸ“¥ Cria como rascunho para vocÃª revisar antes de publicar
          prerelease: false # ğŸš€ NÃ£o Ã© prÃ©-release
          files: build/app/outputs/flutter-apk/app-release-*.apk # ğŸ“ Anexa o APK Ã  Release
